name: Publish to crates.io

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-publish-${{ hashFiles('**/Cargo.lock') }}

      - name: Exchange GitHub OIDC token for crates.io token
        id: crates-io-token
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const oidcToken = await core.getIDToken('crates.io');
            const response = await fetch('https://crates.io/api/v1/trusted_publishing/tokens', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'User-Agent': 'hmac-circuit-breaker (allan@pqcrypta.com)',
              },
              body: JSON.stringify({ jwt: oidcToken }),
            });
            const json = await response.json();
            if (!response.ok) {
              throw new Error(`crates.io token exchange failed (${response.status}): ${JSON.stringify(json)}`);
            }
            core.setSecret(json.token);
            core.setOutput('token', json.token);

      - name: Publish hmac-circuit-breaker
        run: cargo publish --features axum
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-io-token.outputs.token }}
